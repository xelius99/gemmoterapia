<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ErboStrategy AI</title>
    
    <!-- PWA Configuration (Inlined) -->
    <meta name="theme-color" content="#065f46" />
    <meta name="description" content="Assistente AI per erboristi e naturopati" />
    
    <!-- iOS Specific Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="ErboStrategy" />
    
    <!-- Favicon (Dynamic SVG Leaf ðŸŒ¿) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŒ¿</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23ecfdf5%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>ðŸŒ¿</text></svg>">

    <!-- Manifest Data URI for Single File Portability -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22ErboStrategy%20AI%22%2C%22short_name%22%3A%22ErboStrategy%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ecfdf5%22%2C%22theme_color%22%3A%22%23065f46%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3E%F0%9F%8C%BF%3C%2Ftext%3E%3C%2Fsvg%3E%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%7D%5D%7D' />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Babel for in-browser JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Lato', sans-serif;
        background-color: #fcfdfa;
        overscroll-behavior-y: none;
      }
      h1, h2, h3, h4 {
        font-family: 'Playfair Display', serif;
      }
      .markdown-prose h1 { font-size: 1.5em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #064e3b; }
      .markdown-prose h2 { font-size: 1.25em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #065f46; }
      .markdown-prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
      .markdown-prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
      .markdown-prose p { margin-bottom: 1em; line-height: 1.6; }
      .markdown-prose strong { color: #064e3b; font-weight: 700; }
      .markdown-prose blockquote { border-left: 4px solid #10b981; padding-left: 1em; font-style: italic; color: #4b5563; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      import React, { useState, useRef, useEffect } from "https://esm.sh/react@19.2.4";
      import { createRoot } from "https://esm.sh/react-dom@19.2.4/client";
      import { GoogleGenAI } from "https://esm.sh/@google/genai@1.38.0";
      import ReactMarkdown from "https://esm.sh/react-markdown@10.1.0";

      // ----------------------------------------------------------------------
      // CONFIGURAZIONE API KEY
      // ----------------------------------------------------------------------
      // IMPORTANTE: Sostituisci la scritta qui sotto con la tua vera API Key di Google (quella che inizia con "AIza...")
      // Mantieni le virgolette!
      const API_KEY = "AIzaSyDWKCwKh3Z4HIfY4aCTHCU9jQvKlOHeBTk"; 
      // ----------------------------------------------------------------------


      // --- Components ---

      function InstallGuideModal({ onClose }) {
        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 relative animate-fade-in">
              <button 
                onClick={onClose}
                className="absolute top-4 right-4 text-stone-400 hover:text-stone-600"
              >
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
              
              <h3 className="text-xl font-bold text-emerald-800 mb-4 flex items-center gap-2">
                <span className="text-2xl">ðŸ“±</span> Installazione App
              </h3>
              
              <div className="space-y-4 text-stone-700">
                <p className="text-sm">
                  Per utilizzare ErboStrategy come una vera app (senza barra del browser e a tutto schermo), segui questi passaggi:
                </p>
                
                <div className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                  <h4 className="font-bold text-emerald-700 mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clipRule="evenodd" />
                    </svg>
                    Su iPhone (iOS)
                  </h4>
                  <ol className="list-decimal list-inside text-sm space-y-1 ml-1">
                    <li>Apri questo sito con <strong>Safari</strong>.</li>
                    <li>Tocca il pulsante <strong>Condividi</strong> (quadrato con freccia in alto).</li>
                    <li>Scorri e seleziona <strong>"Aggiungi alla schermata Home"</strong>.</li>
                  </ol>
                </div>

                <div className="bg-stone-50 p-4 rounded-lg border border-stone-200">
                   <h4 className="font-bold text-emerald-700 mb-2 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                    </svg>
                    Su Android
                  </h4>
                  <ol className="list-decimal list-inside text-sm space-y-1 ml-1">
                    <li>Apri il menu di Chrome (tre puntini in alto).</li>
                    <li>Seleziona <strong>"Installa app"</strong> o <strong>"Aggiungi a schermata Home"</strong>.</li>
                  </ol>
                </div>
              </div>
              
              <button 
                onClick={onClose}
                className="mt-6 w-full bg-emerald-700 text-white py-2 rounded-lg font-semibold hover:bg-emerald-800 transition-colors"
              >
                Ho capito
              </button>
            </div>
          </div>
        );
      }

      function Header({ onNewConsultation }) {
        const [confirming, setConfirming] = useState(false);
        const [showHelp, setShowHelp] = useState(false);

        const handleClick = () => {
          if (confirming) {
            onNewConsultation();
            setConfirming(false);
          } else {
            setConfirming(true);
            setTimeout(() => setConfirming(false), 3000);
          }
        };

        return (
          <>
            <header className="bg-emerald-800 text-white p-6 shadow-md sticky top-0 z-40">
              <div className="max-w-6xl mx-auto flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-8 w-8 text-emerald-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                  </svg>
                  <div>
                    <h1 className="text-xl md:text-2xl font-bold tracking-wide">ErboStrategy AI</h1>
                    <p className="text-emerald-200 text-xs md:text-sm hidden md:block">Assistente per Professionisti Erboristi</p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3">
                  <button
                    onClick={() => setShowHelp(true)}
                    className="p-2 bg-emerald-900 bg-opacity-30 rounded-full hover:bg-opacity-50 text-emerald-100 transition-all"
                    title="Come installare l'app"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </button>

                  <button
                    onClick={handleClick}
                    type="button"
                    className={`px-3 py-2 md:px-4 md:py-2 rounded-lg text-sm font-bold shadow-sm transition-all flex items-center gap-2 hover:shadow-md whitespace-nowrap ${
                      confirming 
                        ? "bg-amber-600 hover:bg-amber-700 text-white border border-amber-500" 
                        : "bg-emerald-700 hover:bg-emerald-600 text-white border border-emerald-500"
                    }`}
                  >
                    {confirming ? (
                      <>
                        <span className="hidden md:inline">Confermi Reset?</span>
                        <span className="md:hidden">Conferma</span>
                      </>
                    ) : (
                      <>
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span className="hidden md:inline">Nuovo Consulto</span>
                        <span className="md:hidden">Nuovo</span>
                      </>
                    )}
                  </button>
                </div>
              </div>
            </header>
            {showHelp && <InstallGuideModal onClose={() => setShowHelp(false)} />}
          </>
        );
      }

      function SectionTitle({ title, icon, actions }) {
        return (
          <div className="flex justify-between items-center border-b-2 border-emerald-100 pb-2 mb-4">
            <h2 className="text-xl font-bold text-emerald-800 flex items-center gap-2">
              {icon}
              {title}
            </h2>
            {actions && <div>{actions}</div>}
          </div>
        );
      }

      function Disclaimer() {
        return (
          <div className="bg-amber-50 border-l-4 border-amber-500 p-4 mb-6 rounded-r shadow-sm">
            <div className="flex">
              <div className="flex-shrink-0">
                <svg className="h-5 w-5 text-amber-500" viewBox="0 0 20 20" fill="currentColor">
                  <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                </svg>
              </div>
              <div className="ml-3">
                <p className="text-sm text-amber-700">
                  <strong>Disclaimer:</strong> Questo strumento Ã¨ un supporto decisionale basato sull'IA.
                  Verifica sempre le interazioni farmacologiche e le controindicazioni con fonti ufficiali.
                  L'IA puÃ² commettere errori.
                </p>
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [loading, setLoading] = useState(false);
        const [result, setResult] = useState(null);
        
        // Form State
        const [age, setAge] = useState("");
        const [sex, setSex] = useState("F");
        const [pathologies, setPathologies] = useState("");
        const [medications, setMedications] = useState("");
        
        // Library State (Persisted)
        const [library, setLibrary] = useState([]);
        const [manualEntry, setManualEntry] = useState("");
        const [manualTitle, setManualTitle] = useState("");
        const fileInputRef = useRef(null);
        const jsonImportRef = useRef(null);

        // Load from localStorage on mount
        useEffect(() => {
          const saved = localStorage.getItem("erboLibrary");
          if (saved) {
            try {
              setLibrary(JSON.parse(saved));
            } catch (e) {
              console.error("Failed to parse library", e);
            }
          }
        }, []);

        // Save to localStorage whenever library changes
        useEffect(() => {
          localStorage.setItem("erboLibrary", JSON.stringify(library));
        }, [library]);

        const addToLibrary = (name, content) => {
          const newSource = {
            id: Date.now().toString(),
            name: name || "Nota senza titolo",
            content: content,
            date: new Date().toLocaleDateString()
          };
          setLibrary(prev => [...prev, newSource]);
        };

        const removeFromLibrary = (id) => {
          if (confirm("Sei sicuro di voler rimuovere questa fonte?")) {
            setLibrary(prev => prev.filter(item => item.id !== id));
          }
        };

        const handleFileUpload = async (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          if (file.type === "text/plain") {
            const text = await file.text();
            addToLibrary(file.name, text);
          } else {
            alert("Per ora sono supportati solo file di testo (.txt). Per i PDF, per favore copia e incolla il testo nell'area 'Aggiungi nota manuale'.");
          }
          // Reset input
          e.target.value = "";
        };

        const handleManualAdd = () => {
          if (!manualEntry.trim()) return;
          addToLibrary(manualTitle || "Appunti manuali", manualEntry);
          setManualEntry("");
          setManualTitle("");
        };

        // --- EXPORT / IMPORT FEATURE ---
        const handleExportLibrary = () => {
          if (library.length === 0) {
            alert("La biblioteca Ã¨ vuota, non c'Ã¨ nulla da salvare.");
            return;
          }
          const dataStr = JSON.stringify(library, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = "biblioteca_erborista.json";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };

        const handleImportLibrary = (e) => {
          const file = e.target.files?.[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const importedData = JSON.parse(event.target.result);
              if (Array.isArray(importedData)) {
                if(confirm("Vuoi sostituire la biblioteca attuale (OK) o aggiungere a quella esistente (Annulla)?")) {
                   setLibrary(importedData);
                } else {
                   setLibrary(prev => [...prev, ...importedData]);
                }
                alert("Biblioteca caricata con successo!");
              } else {
                alert("Il file non sembra essere un backup valido.");
              }
            } catch (err) {
              alert("Errore nella lettura del file di backup.");
            }
          };
          reader.readAsText(file);
          e.target.value = ""; // Reset
        };

        const handleReset = () => {
          setAge("");
          setSex("F");
          setPathologies("");
          setMedications("");
          setResult(null);
        };

        const handleAnalyze = async () => {
          if (API_KEY === "AIzaSyDWKCwKh3Z4HIfY4aCTHCU9jQvKlOHeBTk") {
            alert("ERRORE DI CONFIGURAZIONE:\n\nNon hai inserito la tua API KEY nel codice!\n\nApri il file index.html con un editor di testo, cerca la riga 'const API_KEY' e incolla la tua chiave.");
            return;
          }

          if (!age || !pathologies) {
            alert("Per favore inserisci almeno EtÃ  e Patologie/Disturbi.");
            return;
          }

          setLoading(true);
          setResult("");

          try {
            const ai = new GoogleGenAI({ apiKey: API_KEY });
            
            // Compile context from library
            const contextString = library.length > 0 
              ? library.map(s => `--- FONTE: ${s.name} ---\n${s.content}`).join("\n\n")
              : "Nessuna fonte specifica allegata. Usa la tua conoscenza generale.";

            const prompt = `
      Sei un esperto erborista, naturopata e fitoterapeuta con anni di esperienza clinica. 
      Il tuo compito Ã¨ elaborare una strategia terapeutica basata sui dati del cliente forniti e sulle fonti allegate.

      Dati Cliente:
      - EtÃ : ${age}
      - Sesso: ${sex}
      - Patologie / Disturbi attuali: ${pathologies}
      - Farmaci in uso: ${medications || "Nessuno dichiarato"}

      BIBLIOTECA PERSONALE DELL'ERBORISTA (Fonti prioritarie):
      """
      ${contextString}
      """

      Compiti:
      1. Analizza il quadro costituzionale e sintomatico del cliente.
      2. Suggerisci rimedi specifici (es. Tinture Madri, Gemmoderivati, Tisane, Integratori) BASANDOTI PRIORITARIAMENTE SULLE FONTI FORNITE SOPRA. Se le fonti non coprono il caso, integra con la letteratura standard specificandolo.
      3. Specifica, dove possibile, i dosaggi indicativi.
      4. CONTROLLO SICUREZZA (Critico): Analizza rigorosamente le possibili interazioni tra i rimedi naturali proposti e i farmaci indicati dal cliente (es. ${medications}). Evidenzia chiaramente eventuali controindicazioni.
      5. Fornisci consigli sullo stile di vita correlati.

      Rispondi in formato Markdown ben strutturato. Usa titoli, elenchi puntati e grassetto per le parti importanti.
      `;

            const response = await ai.models.generateContentStream({
              model: "gemini-3-pro-preview",
              contents: [
                {
                  role: "user",
                  parts: [{ text: prompt }],
                },
              ],
              config: {
                thinkingConfig: { thinkingBudget: 2048 }, 
              }
            });

            let fullText = "";
            for await (const chunk of response) {
              fullText += chunk.text;
              setResult(fullText);
            }
          } catch (error) {
            console.error("Errore durante la generazione:", error);
            alert("Si Ã¨ verificato un errore: " + error.message + "\n\nControlla che la tua API KEY sia corretta.");
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="min-h-screen flex flex-col">
            <Header onNewConsultation={handleReset} />
            
            <main className="flex-grow bg-stone-50 p-4 md:p-8">
              <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                {/* Left Column: Input Form */}
                <div className="space-y-6">
                  <Disclaimer />
                  
                  {/* ANAMNESI SECTION */}
                  <div className="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <SectionTitle 
                      title="Anamnesi Cliente" 
                      icon={
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                        </svg>
                      }
                    />
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="block text-sm font-semibold text-stone-700 mb-1">EtÃ </label>
                        <input
                          type="number"
                          value={age}
                          onChange={(e) => setAge(e.target.value)}
                          className="w-full border border-stone-300 rounded p-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                          placeholder="Es. 45"
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold text-stone-700 mb-1">Sesso</label>
                        <select
                          value={sex}
                          onChange={(e) => setSex(e.target.value)}
                          className="w-full border border-stone-300 rounded p-2 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none"
                        >
                          <option value="F">Femmina</option>
                          <option value="M">Maschio</option>
                          <option value="Altro">Altro</option>
                        </select>
                      </div>
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-semibold text-stone-700 mb-1">Patologie / Sintomi</label>
                      <textarea
                        value={pathologies}
                        onChange={(e) => setPathologies(e.target.value)}
                        className="w-full border border-stone-300 rounded p-2 h-24 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none resize-none"
                        placeholder="Es. Insonnia, gastrite, stress..."
                      />
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm font-semibold text-stone-700 mb-1">Farmaci Assunti</label>
                      <textarea
                        value={medications}
                        onChange={(e) => setMedications(e.target.value)}
                        className="w-full border border-stone-300 rounded p-2 h-20 focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 outline-none resize-none"
                        placeholder="Es. Eutirox, Cardioaspirina..."
                      />
                    </div>
                  </div>

                  {/* LIBRARY SECTION */}
                  <div className="bg-white p-6 rounded-lg shadow-sm border border-stone-200">
                    <SectionTitle 
                      title="Biblioteca Personale" 
                      icon={
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                      }
                      actions={
                        <div className="flex gap-2">
                           <button 
                            onClick={handleExportLibrary}
                            title="Salva backup"
                            className="text-xs flex items-center gap-1 bg-stone-100 hover:bg-stone-200 text-stone-700 px-2 py-1 rounded border border-stone-300"
                          >
                             <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                            </svg>
                             Salva
                          </button>
                           <button 
                            onClick={() => jsonImportRef.current?.click()}
                            title="Carica backup"
                            className="text-xs flex items-center gap-1 bg-stone-100 hover:bg-stone-200 text-stone-700 px-2 py-1 rounded border border-stone-300"
                          >
                             <svg xmlns="http://www.w3.org/2000/svg" className="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                             Carica
                          </button>
                          <input 
                            type="file" 
                            ref={jsonImportRef} 
                            onChange={handleImportLibrary} 
                            className="hidden" 
                            accept=".json"
                          />
                        </div>
                      }
                    />
                    <p className="text-xs text-stone-500 mb-4">
                      I testi caricati qui vengono <strong>salvati nel browser</strong>. Usa i tasti "Salva/Carica" per fare backup o spostare la biblioteca.
                    </p>
                    
                    {/* Library List */}
                    {library.length > 0 && (
                      <div className="mb-6 space-y-2 max-h-48 overflow-y-auto bg-stone-50 p-2 rounded border border-stone-100">
                        {library.map((item) => (
                          <div key={item.id} className="flex items-center justify-between bg-white p-2 rounded shadow-sm text-sm border-l-4 border-emerald-500">
                            <div className="truncate pr-2">
                              <span className="font-semibold text-emerald-900 block truncate">{item.name}</span>
                              <span className="text-xs text-stone-400">Caricato il {item.date} â€¢ {item.content.length} caratteri</span>
                            </div>
                            <button 
                              onClick={() => removeFromLibrary(item.id)}
                              className="text-stone-400 hover:text-red-500 p-1"
                              title="Rimuovi fonte"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                              </svg>
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    {/* Add New Source */}
                    <div className="border-t border-stone-100 pt-4">
                      <h4 className="text-sm font-bold text-stone-700 mb-2">Aggiungi Nuova Fonte</h4>
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                         <button 
                          onClick={() => fileInputRef.current?.click()}
                          className="flex items-center justify-center gap-2 bg-emerald-50 text-emerald-700 border border-emerald-200 py-2 rounded text-sm hover:bg-emerald-100 transition-colors"
                        >
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                          </svg>
                          Carica file .txt
                        </button>
                        <input 
                          type="file" 
                          ref={fileInputRef} 
                          onChange={handleFileUpload} 
                          className="hidden" 
                          accept=".txt"
                        />
                      </div>

                      <div className="space-y-2 mt-2">
                        <input
                          type="text"
                          value={manualTitle}
                          onChange={(e) => setManualTitle(e.target.value)}
                          placeholder="Titolo (es. Manuale Tinture)"
                          className="w-full border border-stone-300 rounded p-2 text-sm focus:border-emerald-500 outline-none"
                        />
                        <textarea
                          value={manualEntry}
                          onChange={(e) => setManualEntry(e.target.value)}
                          className="w-full border border-stone-300 rounded p-2 h-20 focus:border-emerald-500 outline-none font-mono text-xs"
                          placeholder="Incolla qui il testo del PDF o del libro..."
                        />
                        <button 
                          onClick={handleManualAdd}
                          disabled={!manualEntry.trim()}
                          className="w-full bg-stone-700 text-white py-1.5 rounded text-sm hover:bg-stone-800 disabled:opacity-50"
                        >
                          Aggiungi alla Biblioteca
                        </button>
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={handleAnalyze}
                    disabled={loading}
                    className={`w-full py-3 px-4 rounded-lg shadow font-bold text-white transition-all transform hover:-translate-y-0.5
                      ${loading 
                        ? "bg-stone-400 cursor-not-allowed" 
                        : "bg-emerald-700 hover:bg-emerald-800 focus:ring-4 focus:ring-emerald-300"
                      }`}
                  >
                    {loading ? (
                      <div className="flex items-center justify-center gap-2">
                        <svg className="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                          <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                          <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Elaborazione...
                      </div>
                    ) : (
                      "Elabora Strategia Terapeutica"
                    )}
                  </button>
                </div>

                {/* Right Column: Output */}
                <div className="bg-white p-6 rounded-lg shadow-sm border border-stone-200 min-h-[500px] flex flex-col">
                   <SectionTitle 
                      title="Strategia Consigliata" 
                      icon={
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                      }
                    />
                  
                  <div className="flex-grow">
                    {!result && !loading && (
                      <div className="h-full flex flex-col items-center justify-center text-stone-400 opacity-60">
                        <svg xmlns="http://www.w3.org/2000/svg" className="h-24 w-24 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
                        </svg>
                        <p>Inserisci i dati e clicca "Elabora" per visualizzare la strategia.</p>
                      </div>
                    )}
                    
                    {result && (
                      <div className="markdown-prose text-stone-800">
                        <ReactMarkdown>{result}</ReactMarkdown>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </main>
          </div>
        );
      }

      const root = createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>